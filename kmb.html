<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMB Arrival Time</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>KMB Arrival Time</h1>
    <p>Please input route</p>
    <input type="text" onkeyup="rte_input_change();" id="rte_input" placeholder="Enter Route">
    <select id="rte_options_select"></select>
    <input type="button" onclick="update();" value="Update">
    <div id="results"></div>
    <script>
      let route_data;
      setup_data()
      function setup_data() {
        fetch("https://data.etabus.gov.hk/v1/transport/kmb/route/")
        .then(response => {
          return response.json();
        })
        .then(data => {
          route_data = data;
        });
      }
      function rte_input_change() {
        let rte_input = document.getElementById("rte_input").value;
        let rte_options = [];
        let rte_options_select = document.getElementById("rte_options_select");
        rte_options_select.innerHTML = "";
        for (const rte_data of route_data["data"]) {
          if (rte_data["route"] == rte_input.toUpperCase()) {
            let rte_option_display = ;
            if (rte_data["service_type"] != "1") {
              rte_option_display = `${rte_data["orig_tc"]}å¾€${rte_data["dest_tc"]}(${rte_data["service_type"]})`;
            }
            rte_options_select.append(new Option(rte_option_display, `${rte_data["bound"]};${rte_data["service_type"]}`));
          }
        }
      }
      async function update() {
      }
      function to_display(received_data) {
        let results = "";
        for (let i = 0; i < received_data.length; i++) {
          const stop_data = all_stop_data[Object.keys(all_stop_data)[document.getElementById("bus_stop").value]];
          const plat_data = stop_data[Object.keys(stop_data)[document.getElementById("stop_dir").value]];
          results += `<p>${plat_data[i][0]}</p>`;
          let processed_data = {};
          for (const k of received_data[i]["data"]) {
            if (k["eta"]) {
              if (processed_data[k["route"]] && !processed_data[k["route"]].includes(new Date(k["eta"]))) {
                processed_data[k["route"]].push([k["seq"], new Date(k["eta"])]);
              } else {
                processed_data[k["route"]] = [k["dest_en"], [k["seq"], new Date(k["eta"])]];
              }
            }
          }
          console.log(processed_data);
          Object.entries(processed_data).forEach(([key, value]) => {
            results += `<br>${key} ${value[0]}`;
            for (let i = 1; i < value.length; i++) {
              if ((new Date(value[i][1]) - new Date())/60000 < -2) {
                return;
              }
              results += ` ${Math.round((new Date(value[i][1]) - new Date())/6000)/10}`;
            }
          });
        }
        document.getElementById("results").innerHTML = results;
      }
    </script>
  </body>
</html>
