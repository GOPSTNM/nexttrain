<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMB Arrival Time</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>KMB Arrival Time</h1>
    <p>Please input route</p>
    <input type="text" onkeyup="rte_input_change();" id="rte_input" placeholder="Enter Route">
    <select id="rte_options_select"></select>
    <input type="button" onclick="update();" value="Update">
    <div id="results"></div>
    <script>
      let route_data;
      setup_data();
      function setup_data() {
        fetch("https://data.etabus.gov.hk/v1/transport/kmb/route/")
        .then(response => {
          return response.json();
        })
        .then(data => {
          route_data = data;
        });
      }
      function rte_input_change() {
        let rte_input = document.getElementById("rte_input").value;
        let rte_options = [];
        let rte_options_select = document.getElementById("rte_options_select");
        rte_options_select.innerHTML = "";
        for (const rte_data of route_data["data"]) {
          if (rte_data["route"] == rte_input.toUpperCase()) {
            rte_options_select.append(new Option(`${rte_data["orig_tc"]}å¾€${rte_data["dest_tc"]}(${rte_data["service_type"]})`, `${rte_data["bound"]};${rte_data["service_type"]}`));
          }
        }
      }
      async function update() {
        try {
          let fd = document.getElementById("rte_options_select").value.split(";");
          let route = document.getElementById("rte_input").value.toUpperCase();
          const responses = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-eta/${route}/${fd[1]}`);
          const stop_responses = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${fd[0] == "I" ? "inbound" : "outbound"}/${fd[1]}`);
          const received_data = await responses.json();
          const stop_received_data = await stop_responses.json();
          to_display(received_data, stop_received_data);
        } catch (error) {
          console.log(error);
        }
      }
      async function to_display(received_data, stop_data) {
        console.log(received_data);
        let results = "";
        let stop_names = [];
        const fetchPromises = stop_data["data"].map(async (i) => {
          const response = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${i["stop"]}`);
          const received_data = await response.json();
          return { seq: Number(i["seq"]), name: received_data["data"]["name_tc"] };
        });
        const stop_name_results = await Promise.all(fetchPromises);
        stop_name_results.forEach(({ seq, name }) => {
          stop_names[seq] = name;
        });
        console.log(stop_names);
        for (const i of received_data["data"]) {
        }
        document.getElementById("results").innerHTML = results;
      }
    </script>
  </body>
</html>
