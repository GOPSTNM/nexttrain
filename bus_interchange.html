<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Interchange Arrival Time</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>Bus Interchange Arrival Time</h1>
    <p>Please select Bus Interchange</p>
    <select id="bus_stop" onload="stopchange();" onchange="stopchange();">
      <option value=0>Western Harbour Crossing</option>
    </select>
    <select id="stop_dir" onload="stopchange();" onchange="stopchange();">
      <option value=0>Nga Cheung Road</option>
      <option value=1>To Hong Kong</option>
      <option value=2>To Kowloon</option>
    </select>
    <input type="button" onclick="update();" value="Find">
    <div id="results"></div>
    <script>
      let all_stop_data;
      setup_stop_data();
      function setup_stop_data() {
        fetch("bus_data/bus_interchange.json")
        .then(response => {
          return response.json();
        })
        .then(data => {
          all_stop_data = data;
        });
      }
      async function update() {
        const stop_data = all_stop_data[Object.keys(all_stop_data)[document.getElementById("bus_stop").value]];
        const plat_data = stop_data[Object.keys(stop_data)[document.getElementById("stop_dir").value]];
        try {
          const responses = await Promise.all(plat_data.map(pd => fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${pd[1]}`)));
          const received_data = await Promise.all(responses.map(response => response.json()));
          to_display(received_data);
        } catch (error) {
          alert("Error");
        }
      }
      function to_display(received_data) {
        let results = "Routes";
        for (const item of received_data) {
          for (const i of item["data"]) {
            if (new Date(i["eta"]) >= new Date()) {
              results += `<br>${i["route"]} ${i["dest_en"]} ${Math.round((new Date(i["eta"]) - new Date()) / (1000 * 60))}`;
            }
          }
        }
        document.getElementById("results").innerHTML = results;
      }
    </script>
  </body>
</html>
