<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Rail Arrival Time</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>Light Rail Arrival Time</h1>
    <p>Please select Light Rail Stop</p>
    <select id="lightrailzone" onchange="zonechange();">
      <option selected="true" value=8>Show Stops in All Zones</option>
      <option value=7>Tuen Ma Line Interchange</option>
      <option value=1>Zone 1</option>
      <option value=2>Zone 2</option>
      <option value=3>Zone 3</option>
      <option value=4>Zone 4</option>
      <option value=5>Zone 5</option>
      <option value=6>Zone 5A</option>
    </select>
    <select id="lightrailstop">
    </select>
    <input type="button" onclick="update();" value="Find">
    <div id="results"></div>
    <p>Please note that the info will not be updated automatically</p>
    <script>
      let stopdata = localStorage.getItem("light_rail_data");
      if (stopdata === null) {
        fetch("light_rail_data/stop_data.json")
          .then(response => response.json())
          .then(data => {
            localStorage.setItem("light_rail_data", JSON.stringify(data));
            stopdata = data;
          });
      } else {
        stopdata = JSON.parse(stopdata);
      }   
      function zonechange() {
        if (document.getElementById("lightrailzone").value == 8) {
          let optionlist = "";
          optionlist += `<optgroup label="Zone 1">${optionreturn(0)}</optgroup>`;
          optionlist += `<optgroup label="Zone 2">${optionreturn(1)}</optgroup>`;
          optionlist += `<optgroup label="Zone 3">${optionreturn(2)}</optgroup>`;
          optionlist += `<optgroup label="Zone 4">${optionreturn(3)}</optgroup>`;
          optionlist += `<optgroup label="Zone 5">${optionreturn(4)}</optgroup>`;
          optionlist += `<optgroup label="Zone 5A">${optionreturn(5)}</optgroup>`;
          document.getElementById("lightrailstop").innerHTML = optionlist;
        } else {
          document.getElementById("lightrailstop").innerHTML = optionreturn(document.getElementById("lightrailzone").value-1);
        }
      }
      function optionreturn(zone) {
        return Object.keys(stopdata[zone]).map(key => `<option value="${stopdata[zone][key]}">${key}</option>`).join('');
      }
      function lookfortrain () {
        var url = "https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=" + document.getElementById("lightrailstop").value;
        fetch(url).then(response => response.json()).then(function(data){
          if (data["status"] == 0) {
            alert("No Data."); 
          } else {
            var table = "<table><tr><td width=12.5%>Route</td><td width=60%>Destination</td><td width=7.5%>Car</td><td width=20%>Min</td></tr>";
            for (let i = 0; i < data["platform_list"].length; i++) {
              let plat = i;
              var table = table + "<tr><th colspan=4>Platform " + data["platform_list"][plat]["platform_id"] + 
                "</th></tr>";
              for (let i = 0; i < data["platform_list"][plat]["route_list"].length; i++) {
                var time = parseInt(data["platform_list"][plat]["route_list"][i]["time_en"]);
                if (isNaN(time) == true){
                  var time = data["platform_list"][plat]["route_list"][i]["time_en"];
                  if (time == "Arriving"){
                    var time = "<div class='blink'>1</div>";
                  }
                  if (time == "-"){
                    var time = "<div class='blink'>0</div>";
                  }
                  if (time == "Departing"){
                    var time = "-";
                  }
                }
                var table = table + "<tr><td>" + data["platform_list"][plat]["route_list"][i]["route_no"] + "</td><td>" + 
                  data["platform_list"][plat]["route_list"][i]["dest_en"] + "</td><td>" + 
                  data["platform_list"][plat]["route_list"][i]["train_length"] + "</td><td>" + 
                  time + "</td></tr>";
              }
            }
            document.getElementById("results").innerHTML = table + "</table>";
          }
        });
      }
    </script>
  </body>
</html>
