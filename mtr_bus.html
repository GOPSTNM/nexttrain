<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTR Bus Arrival Time</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>MTR Bus Arrival Time</h1>
    <p>Please select bus route</p>
    <select id="route"></select>
    <input type="button" value="Update" onclick="update()">
    <input type="button" value="Change Direction" onclick="changedirection()">
    <div id="message_area"></div>
    <div id="results"></div>
    <p>Please note that the information will not be updated automatically</p>
    <label class="checkbox_container">
      <input type="checkbox" id="rte_description_english" onchange="routedata_to_options();">
      <span class="checkbox_checkmark"></span>
      <p>Show Route Description in English</p>
    </label>
    <label class="checkbox_container">
      <input type="checkbox" id="show_speaker" onchange="">
      <span class="checkbox_checkmark"></span>
      <p>Show Speaker Information</p>
    </label>
    <p class="underline_text" onclick="update_route();">Update Route Information</p>
    <p class="underline_text" onclick="update_speaker();">Update Speaker Information</p>
    <p class="description_text">The information is provided by the Digital Policy Office and for reference only</p>
    <script>
      let viewdirection = 0;
      let recdata;
      let updtime;
      let speaker = localStorage.getItem("mtr_bus_speaker_info");
      let routedata = localStorage.getItem("mtr_bus_data");
      if (routedata === null) {
        fetch("mtr_bus_data/mtr_bus_route_stop_list.json")
          .then(response => response.json())
          .then(data => {
            localStorage.setItem("mtr_bus_data", JSON.stringify(data));
            routedata = data;
            routedata_to_options();
          });
      } else {
        routedata = JSON.parse(routedata);
        routedata_to_options();
      }
      if (speaker === null) {
        fetch("mtr_bus_data/speaker_info.txt")
          .then(response => response.text())
          .then(data => {
            localStorage.setItem("mtr_bus_speaker_info", data);
            speaker = data.split("\n");
          });
      } else {
        speaker = speaker.split("\n");
      }
      function routedata_to_options() {
        let optionlist = "";
        for (const item in routedata) {
          optionlist += `<option value="${item}">${item} ${routedata[item]["Description"][document.getElementById("rte_description_english").checked == true ? 1 : 0]}</option>`;
        }
        document.getElementById("route").innerHTML = optionlist;
      }
      function changedirection() {
        viewdirection = (viewdirection + 1) % 2;
        todisplay();
      }
      function update() {
        let params = {
          language: "en",
          routeName: document.getElementById("route").value
        };
        let timeout = false;
        const timeoutid = setTimeout(() => {timeout = true; document.getElementById("message_area").innerHTML = "<p>No response received, please try again.</p>";}, 3000);
        fetch("https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule", {method: "POST", headers:{"Content-Type": "application/json"}, body: JSON.stringify(params)})
           .then(response => {
             clearTimeout(timeoutid);
             if (timeout) return;
             return response.json();
           })
           .then(data => {
             if (timeout) return;
             recdata = data;
             updtime = new Date().toTimeString().split(" ")[0];
             todisplay();
           })
      }
      function todisplay() {
        document.getElementById("message_area").innerHTML = "";
        let results = `<p>Last Updated: ${updtime}</p>`;
        let route = document.getElementById("route").value; 
        if (Object.keys(routedata[route]).length == 2) {
          viewdirection = 0;
        }
        let viewdirectionval = Object.keys(routedata[route])[viewdirection + 1];
        console.log(viewdirectionval);
        let stop_id;
        for (let i = 0; i < Object.keys(routedata[route][viewdirectionval]).length; i++) {
          stop_id = Object.keys(routedata[route][viewdirectionval])[i];
          results += `<div style="display: flex; align-items: center;" id="${stop_id}" onclick="change('${stop_id}');"><div class="stop_circ"></div><p style="margin: 0px; display: inline-block;">${routedata[route][viewdirectionval][stop_id]}</p></div>`;
          for (const item of recdata["busStop"]) {
            if (item["busStopId"] == `${route}-${stop_id}`) {
              results += `<table style='margin: 0px 0px 0px 43px; display: none;' id='${stop_id}_data'>`;
              for (let k = 0; k < item["bus"].length; k++) {
                results += "<tr>";
                let bus_id = item["bus"][k]["busId"];
                let arrive = Math.round(item["bus"][k]["arrivalTimeInSecond"]/6)/10;
                let depart = Math.round(item["bus"][k]["departureTimeInSecond"]/6)/10;
                if (!bus_id) {
                  bus_id = "-";
                }
                let note = "";
                if (item["bus"][k]["isScheduled"] == "1") {
                  note = "<span class='medium_text'>Scheduled</span>";
                }
                let time_data = "";
                if (i == 0) {
                  time_data = `<span class="bold_text">${depart}</span> <span class="small_text">min</span>`;
                } else if (i == Object.keys(routedata[route][viewdirectionval]).length - 1) {
                  time_data = `<span class="bold_text">${arrive}</span> <span class="small_text">min</span>`;
                } else if (arrive < 0.25) {
                  time_data = "<span class='bold_text'>Departing</span>";
                } else if (arrive < 0.5) {
                  time_data = "<span class='bold_text'>Arriving</span>";
                } else {
                  time_data = `<span class="bold_text">${arrive}</span> <span class="small_text">min</span>`;
                }
                results += `<td style="width: 70px">${bus_id}</td>`;
                results += `<td style="width: 100px">${time_data}</td>`;
                results += `<td>${note}</td>`;
                results += "</tr>";
                if (document.getElementById("show_speaker").checked == true) {
                  results += getspeaker(bus_id);
                }
              }
              results += "</table>";
            }
          }
        }
        document.getElementById("results").innerHTML = results;
      }
      function getspeaker(id) {
        let speaker_message = "";
        for (let i in speaker) {
          if ((speaker[i].includes(id)) && (id != "-")) {
            let speaker_details = speaker[i].split("\t");
            speaker_message += `<tr><td colspan='3'><details><summary>${speaker_details[0]} ${speaker_details[2]} ${speaker_circ(Math.min(speaker_details[3], speaker_details[4], speaker_details[5], speaker_details[6]))}</summary>Volume ${speaker_circ(speaker_details[3])} Low-Freq ${speaker_circ(speaker_details[4])} Noise ${speaker_circ(speaker_details[5])} General ${speaker_circ(speaker_details[6])} ${speaker_details[7]}</details></td></tr>`;
          }
        }
        return speaker_message;
      }
      function change(elem) {
        let to_change = document.getElementById(elem + "_data");
        to_change.style.display = (to_change.style.display !== "block") ? "block" : "none";
      }
      function speaker_circ(x) {
        let colour;
        if (x >= 0 && x <= 4) {
          colour = "#D2222D";
        } else if (x >= 5 && x <= 7) {
          colour = "#FFBF00";
        } else if (x >= 8 && x <= 10) {
          colour = "#238823";
        }
        return `<div class="inline_circle" style="color: #FFFFFF; background-color: ${colour};">${x}</div>`;
      }
      function update_speaker() {
        if (confirm("Are you sure to update the speaker information?") == true) {
          localStorage.removeItem("mtr_bus_speaker_info");
          location.reload();
          alert("Updated");
        }
      }
      function update_route() {
        if (confirm("Are you sure to update the route information?") == true) {
          localStorage.removeItem("mtr_bus_data");
          location.reload();
          alert("Updated");
        }
      }
    </script>
  </body>
</html>
